// Global variable to track the current stage
let currentStage = 1;

// Function to handle the order button click
function handleOrderButtonClick() {
  
  // Create a modal element
  const orderModal = document.createElement('div');
  orderModal.classList.add('modal', 'fade');
  orderModal.id = 'orderModal';
  
  // Function to construct the modal body based on the current stage
  function constructModalBody() {
    switch (currentStage) {
      case 1:
        return `
          <div class="modal-header">
            <h5 class="modal-title">Order Information</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <label for="firstNameInput">First Name:</label>
            <input type="text" id="firstNameInput" class="form-control" required>
            <label for="lastNameInput">Last Name:</label>
            <input type="text" id="lastNameInput" class="form-control" required>
            <label for="emailInput">Email:</label>
            <input type="email" id="emailInput" class="form-control" required>
            <label for="phoneInput">Phone:</label>
            <input type="phone" id="phoneInput" class="form-control" required>
            <label for="countryinput">Country:</label>
            <input type="country" id="countryInput" class="form-control" required>
            <label for="cityinput">City:</label>
            <input type="city" id="cityInput" class="form-control" required>
            <label for="addressinput">Address:</label>
            <input type="address" id="addressInput" class="form-control" required>
            <label for="zipinput">Postal Code/ZIP:</label>
            <input type="zip" id="zipInput" class="form-control" required>

            <button id="nextButton" class="next-btn mt-3">Next</button>
          </div>
        `;
      case 2:
        return `
          <div class="modal-header">
            <h5 class="modal-title">Total Cost</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <!-- Display order summary and total cost here -->
            <div>Total Cost: $XXX</div>

            <button id="backButton" class="back-btn mt-3">Back</button>
            <button id="proceedToPaymentButton" class="proceed-btn mt-3">Proceed to Payment</button>
          </div>
        `;
      case 3:
        return `
          <div class="modal-header">
            <h5 class="modal-title">Payment</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <!-- Display PayPal payment options here -->
            <div id="paypal-button-container"></div>

            <button id="submitOrderButton" class="submit-btn mt-3">Submit Order</button>
          </div>
        `;
    }
  }

  // Set the modal content
  orderModal.innerHTML = `
      <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
              ${constructModalBody()}
          </div>
      </div>
  `;

  // Append the modal to the body
  document.body.appendChild(orderModal);

  // Initialize the modal using Bootstrap's modal
  const modal = new bootstrap.Modal(orderModal);

  // Show the modal
  modal.show();

  // Handle navigation between stages
  const nextButton = document.getElementById('nextButton');
  const backButton = document.getElementById('backButton');
  const proceedToPaymentButton = document.getElementById('proceedToPaymentButton');
  
  nextButton.addEventListener('click', function () {
    console.log("it worked, next");
    currentStage++;
    orderModal.innerHTML = `
      <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
              ${constructModalBody()}
          </div>
      </div>
    `;
  });

  backButton.addEventListener('click', function () {
    console.log("it worked, back");
    currentStage--;
    orderModal.innerHTML = `
      <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
              ${constructModalBody()}
          </div>
      </div>
    `;
  });

  proceedToPaymentButton.addEventListener('click', function () {
    currentStage++;
    orderModal.innerHTML = `
      <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
              ${constructModalBody()}
          </div>
      </div>
    `;
  });

// Handle navigation between stages
document.body.addEventListener('click', function (event) {
  const targetId = event.target.id;

  if (targetId === 'nextButton') {
    currentStage++;
  } else if (targetId === 'backButton') {
    currentStage--;
  } else if (targetId === 'proceedToPaymentButton') {
    currentStage++;
  }

  // Update the modal content based on the current stage
  orderModal.innerHTML = `
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Order Information</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            ${constructModalBody()}
        </div>
    </div>
  `;
});

// Handle submission when the user clicks the "Submit Order" button
const submitOrderButton = document.getElementById('submitOrderButton');
submitOrderButton.addEventListener('click', function () {
  // Fetch user input based on the current stage
  const firstName = document.getElementById('firstNameInput').value;
  const lastName = document.getElementById('lastNameInput').value;
  const email = document.getElementById('emailInput').value;
  const phone = document.getElementById('phoneInput').value;
  const country = document.getElementById('countryInput').value;
  const city = document.getElementById('cityInput').value;
  const address = document.getElementById('addressInput').value;
  const zip = document.getElementById('zipInput').value;

  // Additional input fields for other stages as needed

  // Construct the order details based on the current stage
  let orderDetails;
  switch (currentStage) {
    case 1:
      orderDetails = {
        "external_id": "2750e210-39bb-11e9-a503-452618153e6a",
        "label": "00012",
        "line_items": selectedSKUs.map(sku => ({
          "sku": sku,
          "quantity": 1
        })),
        "shipping_method": 1,
        "send_shipping_notification": false,
        "address_to": {
          "first_name": firstName,
          "last_name": lastName,
          "email": email,
          "phone": phone,
          "country": country,
          "city": city,
          "address1": address,
          "zip": zip,
          // Include other user input in address_to
        }
      };
      break;
    case 2:
      // Construct order details for shipping costs
      break;
    case 3:
      // Construct order details for PayPal payment
      break;
  }

  // Make a POST request to Printify's order endpoint
  if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
    fetchURLorder = 'http://localhost:5000/order-processing';
  } else {
    fetchURLorder = 'https://tm-server-4a2a80557ba4.herokuapp.com/order-processing';
  }
  fetch(fetchURLorder, {
    method: 'POST',
    body: JSON.stringify(orderDetails),
    headers: {
      'Content-Type': 'application/json'
    }
  })
    .then(response => response.json())
    .then(data => {
      console.log('Printify order response:', data);
      modal.hide();
    })
    .catch(error => {
      console.error('Error placing order with Printify:', error);
      modal.hide();
    });
});

}